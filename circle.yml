machine:
  environment:
    BASE_DIR: ${GOPATH%%:*}/src/github.com/${CIRCLE_PROJECT_USERNAME}
    REPO_DIR: ${BASE_DIR}/$(basename $(pwd))
    GO15VENDOREXPERIMENT: 1
  services:
    - docker

checkout:
  post:
    - mkdir -p ${BASE_DIR}
    - ln -sf $(pwd) ${REPO_DIR}

dependencies:
  pre:
    - git submodule update --init --recursive
    - sudo bash -c 'echo "deb http://ftp.us.debian.org/debian sid main" >> /etc/apt/sources.list'
    - sudo apt-get update
    - sudo apt-get install libsystemd-dev
  override:
    - cd ${REPO_DIR} && go get -t -d -v ./...
  post:

test:
  pre:
    - cd ${REPO_DIR} && go vet ./...
  override:
    - cd ${REPO_DIR} && go test -v -race -coverprofile=${CIRCLE_ARTIFACTS}/cover.out ./lib/...
    - cd ${REPO_DIR} && go tool cover -func ${CIRCLE_ARTIFACTS}/cover.out -o ${CIRCLE_ARTIFACTS}/cover.txt
    - cd ${REPO_DIR} && go tool cover -html ${CIRCLE_ARTIFACTS}/cover.out -o ${CIRCLE_ARTIFACTS}/cover.html
    - cd ${REPO_DIR} && go build
  post:
    - cd ${REPO_DIR} && go -build

deployment:
  hub:
    branch: master
    commands:
      - docker login -e ${DOCKER_EMAIL} -u ${DOCKER_USER} -p ${DOCKER_PASS}
      - docker build -t segment/ecs-logs .
      - docker tag segment/ecs-logs:latest segment/ecs-logs:${CIRCLE_SHA1}
      - docker push segment/ecs-logs
